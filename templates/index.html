<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>本地向量知识库管理（MacOS优化版）</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #0071e3;
            --primary-dark: #0056b3;
            --success: #34c759;
            --danger: #ff3b30;
            --warning: #ff9500;
            --info: #5ac8fa;
            --dark: #1d1d1f;
            --light: #f5f5f7;
            --gray: #86868b;
            --border: #d2d2d7;
            --card-bg: #ffffff;
            --nav-active: #007aff;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --gradient-danger: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.16);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Roboto, sans-serif;
        }
        body {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
            transition: background 0.3s;
        }
        .container {
            background: var(--card-bg);
            padding: 0;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .header {
            background: var(--gradient-primary);
            padding: 30px 40px;
            color: white;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 400px;
            height: 400px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .header::after {
            content: '';
            position: absolute;
            bottom: -30%;
            left: -10%;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }
        h1 {
            color: white;
            margin-bottom: 8px;
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }
        h1 i {
            font-size: 24px;
        }
        .version {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
            margin-left: auto;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        .header-subtitle {
            color: rgba(255,255,255,0.85);
            font-size: 14px;
            position: relative;
            z-index: 1;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            padding: 24px 40px;
            background: #fafbfc;
            border-bottom: 1px solid var(--border);
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: white;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }
        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
        }
        .stat-icon.blue { background: var(--gradient-primary); }
        .stat-icon.green { background: var(--gradient-success); }
        .stat-icon.orange { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.purple { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .stat-info h4 {
            font-size: 13px;
            color: var(--gray);
            font-weight: 500;
            margin-bottom: 4px;
        }
        .stat-info p {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }
        .section {
            margin: 24px 40px;
            padding: 24px;
            background: #fff;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
            border: 1px solid #f0f0f5;
        }
        .section:hover {
            box-shadow: var(--shadow-md);
        }
        h2 {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary);
        }
        h2 i {
            color: var(--primary);
            width: 28px;
            height: 28px;
            background: rgba(0,113,227,0.1);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
        }
        input, select, textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fafbfc;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0,113,227,0.1);
            background: white;
        }
        input[type="file"] {
            padding: 20px;
            border: 2px dashed var(--border);
            background: #fafbfc;
            cursor: pointer;
        }
        input[type="file"]:hover {
            border-color: var(--primary);
            background: rgba(0,113,227,0.05);
        }
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            padding: 14px 28px;
            border-radius: var(--radius-sm);
            transition: all 0.3s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,113,227,0.3);
        }
        .danger {
            background: var(--danger);
        }
        .danger:hover {
            background: #e63329;
            box-shadow: 0 4px 12px rgba(255,59,48,0.3);
        }
        .secondary {
            background: white;
            color: var(--dark);
            border: 1px solid var(--border);
        }
        .secondary:hover {
            background: #f5f5f7;
            border-color: var(--gray);
        }
        #results {
            margin-top: 20px;
            padding: 20px;
            background: #f8f8ff;
            border-radius: 8px;
            max-height: 500px;
            overflow-y: auto;
            transition: background 0.3s;
        }
        .result-item {
            margin: 15px 0;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .distance {
            color: #0071e3;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .match-score {
            color: #34c759;
            font-size: 12px;
            margin-left: 10px;
        }
        .metadata {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed #eee;
            transition: color 0.3s;
        }
        mark {
            background: #fff3cc;
            padding: 2px 4px;
            border-radius: 2px;
        }
        .progress-container {
            display: none;
            margin-top: 15px;
        }
        .progress-bar {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
            transition: background 0.3s;
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: #0071e3;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .progress-text {
            font-size: 12px;
            margin-top: 5px;
            color: #666;
            transition: color 0.3s;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
            font-size: 16px;
        }
        .loading i {
            margin-right: 10px;
            color: var(--primary);
        }
        .file-list {
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 6px;
            transition: border-color 0.3s;
        }
        .file-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            transition: background 0.2s;
        }
        .file-item:hover {
            background: #f8f8ff;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-checkbox {
            margin-right: 10px;
            width: auto;
        }
        .file-info {
            flex: 1;
        }
        .file-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        .file-meta {
            font-size: 12px;
            color: #666;
        }
        .file-actions {
            display: flex;
            gap: 8px;
        }
        .file-actions button {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 0;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-group button {
            flex: 1;
        }
        .dark-mode-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
            z-index: 1000;
        }

        /* 暗黑模式 */
        body.dark-mode {
            background: #1a1a1a;
        }
        body.dark-mode .container {
            background: #2c2c2e;
            color: #f5f5f7;
        }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode label {
            color: #f5f5f7;
        }
        body.dark-mode .stats, body.dark-mode #results, body.dark-mode .result-item {
            background: #3a3a3c;
        }
        body.dark-mode .section {
            background: #2c2c2e;
            box-shadow: 0 1px 5px rgba(0,0,0,0.3);
        }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
            background: #48484a;
            color: #f5f5f7;
            border-color: #58585a;
        }
        body.dark-mode input[type="file"] {
            border-color: #58585a;
        }
        body.dark-mode .metadata, body.dark-mode .progress-text, body.dark-mode .file-meta {
            color: #aaa;
        }
        body.dark-mode .progress-bar {
            background: #48484a;
        }
        body.dark-mode mark {
            background: #4a4a2c;
            color: #f5f5f7;
        }
        body.dark-mode .file-item:hover {
            background: #3a3a3c;
        }
        body.dark-mode .file-list {
            border-color: #48484a;
        }

        /* 标签页导航 */
        .nav-tabs {
            display: flex;
            gap: 8px;
            margin: 0 40px;
            padding: 20px 40px 0;
            background: #fafbfc;
            border-bottom: 1px solid var(--border);
        }
        .nav-tab {
            padding: 14px 28px;
            background: white;
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent;
            transition: background 0.3s ease;
        }
        .nav-tab:hover {
            color: var(--primary);
            background: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }
        .nav-tab.active {
            color: var(--primary);
            background: white;
            border-bottom-color: white;
            box-shadow: var(--shadow-sm);
        }
        .nav-tab.active::before {
            background: var(--primary);
        }
        body.dark-mode .nav-tabs {
            background: #2c2c2e;
            border-color: #48484a;
        }
        body.dark-mode .nav-tab {
            background: #3a3a3c;
            color: #aaa;
            border-color: #48484a;
        }
        body.dark-mode .nav-tab:hover {
            background: #48484a;
        }
        body.dark-mode .nav-tab.active {
            background: #1c1c1e;
            border-bottom-color: #1c1c1e;
        }

        /* 标签页内容 */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* 训练进度条 */
        .train-progress-container {
            display: none;
            margin-top: 15px;
        }
        .train-progress-bar {
            height: 12px;
            background: #eee;
            border-radius: 6px;
            overflow: hidden;
        }
        .train-progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #0071e3, #34c759);
            border-radius: 6px;
            transition: width 0.3s;
        }
        .train-progress-text {
            font-size: 14px;
            margin-top: 8px;
            color: #666;
        }
        body.dark-mode .train-progress-bar {
            background: #48484a;
        }
        body.dark-mode .train-progress-text {
            color: #aaa;
        }

        /* 训练日志 */
        .train-logs {
            margin-top: 15px;
            padding: 15px;
            background: #f8f8ff;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        body.dark-mode .train-logs {
            background: #3a3a3c;
        }

        /* 模型卡片 */
        .model-card {
            display: inline-block;
            padding: 12px 16px;
            margin: 8px;
            background: #f8f8ff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .model-card:hover {
            border-color: #0071e3;
        }
        .model-card.selected {
            border-color: #0071e3;
            background: #e8f4ff;
        }
        .model-card-name {
            font-weight: 500;
            color: #1d1d1f;
        }
        .model-card-type {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        body.dark-mode .model-card {
            background: #3a3a3c;
        }
        body.dark-mode .model-card-name {
            color: #f5f5f7;
        }
        body.dark-mode .model-card-type {
            color: #aaa;
        }
        body.dark-mode .model-card.selected {
            background: #1a3a5c;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header区域 -->
        <div class="header">
            <h1><i class="fas fa-database"></i> 本地向量知识库管理 <span class="version">v1.0</span></h1>
            <p class="header-subtitle">MacOS优化版 | 支持多格式文件导入 | 向量存储与语义搜索</p>
        </div>

        <!-- 导航标签页 -->
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="knowledge"><i class="fas fa-folder"></i> 知识库管理</button>
            <button class="nav-tab" data-tab="training"><i class="fas fa-brain"></i> 模型训练</button>
        </div>
        <!-- 知识库管理内容 -->
        <div id="tab-knowledge" class="tab-content active">

        <!-- 统计信息 -->
        <div class="stats">
            <div class="stat-item">
                <div class="stat-icon blue"><i class="fas fa-database"></i></div>
                <div class="stat-info">
                    <h4>知识库名称</h4>
                    <p>{{ stats.collection_name | default('default') }}</p>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon green"><i class="fas fa-layer-group"></i></div>
                <div class="stat-info">
                    <h4>总文本块数</h4>
                    <p>{{ stats.total_chunks | default(0) }}</p>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon orange"><i class="fas fa-folder-open"></i></div>
                <div class="stat-info">
                    <h4>存储路径</h4>
                    <p>{{ stats.storage_path | default('./local_vector_db') }}</p>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon purple"><i class="fas fa-file-alt"></i></div>
                <div class="stat-info">
                    <h4>支持文件类型</h4>
                    <p>{{ stats.supported_file_types | join(', ') if stats.supported_file_types else 'pdf, md, xlsx, jpg, png, txt, docx, pptx' }}</p>
                </div>
            </div>
        </div>

        <!-- 1. 文件上传入库 -->
        <div class="section">
            <h2><i class="fas fa-upload"></i> 文件上传 & 入库</h2>
            <form id="uploadForm">
                <div class="form-group">
                    <label for="file">选择文件（支持PDF/MD/Excel/图片/TXT/Word/PPT）</label>
                    <input type="file" id="file" name="file" accept=".pdf,.md,.xlsx,.jpg,.png,.txt,.docx,.pptx" multiple required>
                </div>

                <!-- 进度条 -->
                <div id="uploadProgress" class="progress-container">
                    <div class="progress-bar">
                        <div id="progressBar" class="progress-fill"></div>
                    </div>
                    <div id="progressText" class="progress-text">0% 准备中...</div>
                </div>

                <button type="submit">上传并入库</button>
            </form>
        </div>

        <!-- 2. 相似性检索 -->
        <div class="section">
            <h2><i class="fas fa-search"></i> 相似性检索（混合检索+关键词高亮）</h2>
            <form id="searchForm">
                <div class="form-group">
                    <label for="query">检索关键词</label>
                    <textarea id="query" name="query" rows="3" required>测试查询</textarea>
                </div>
                <div class="form-group">
                    <label for="top_k">返回条数</label>
                    <input type="number" id="top_k" name="top_k" value="5" min="1" max="20">
                </div>
                <div class="form-group">
                    <label for="file_type_filter">文件类型过滤（可选）</label>
                    <select id="file_type_filter" name="file_type_filter">
                        <option value="">全部类型</option>
                        <option value=".pdf">PDF</option>
                        <option value=".md">Markdown</option>
                        <option value=".xlsx">Excel</option>
                        <option value=".jpg">JPG图片</option>
                        <option value=".png">PNG图片</option>
                        <option value=".txt">TXT文本</option>
                        <option value=".docx">Word</option>
                        <option value=".pptx">PPT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hybrid">开启混合检索（向量+关键词）</label>
                    <select id="hybrid" name="hybrid">
                        <option value="true">是（推荐）</option>
                        <option value="false">否（仅向量）</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button type="submit">开始检索</button>
                    <button type="button" id="exportResultsBtn" class="secondary">导出检索结果（JSON）</button>
                </div>
            </form>

            <div id="results"></div>
        </div>

        <!-- 3. 已入库文件管理 -->
        <div class="section">
            <h2><i class="fas fa-folder-open"></i> 已入库文件管理</h2>
            <div class="btn-group">
                <button type="button" id="refreshFilesBtn" class="secondary">刷新文件列表</button>
                <button type="button" id="batchDeleteBtn" class="danger">批量删除选中文件</button>
            </div>

            <div id="fileList" class="file-list">
                <p style="padding: 20px; text-align: center; color: #666;">点击"刷新文件列表"查看已入库文件</p>
            </div>
        </div>

        <!-- 4. 知识库统计图表 -->
        <div class="section">
            <h2><i class="fas fa-chart-pie"></i> 知识库统计图表</h2>
            <div id="fileTypeChart" class="chart-container"></div>
        </div>

        <!-- 5. 知识库操作 -->
        <div class="section">
            <h2><i class="fas fa-exclamation-triangle"></i> 知识库操作（谨慎使用）</h2>
            <button id="clearBtn" class="danger">清空整个知识库</button>
        </div>

        <!-- 模型训练内容 -->
        <div id="tab-training" class="tab-content">
            <!-- 训练数据上传 -->
            <div class="section">
                <h2><i class="fas fa-cloud-upload-alt"></i> 训练数据上传</h2>
                <form id="trainUploadForm">
                    <div class="form-group">
                        <label for="trainFile">选择训练数据（CSV/TXT）</label>
                        <input type="file" id="trainFile" name="trainFile" accept=".csv,.txt" required>
                    </div>
                    <button type="submit">上传训练数据</button>
                </form>
                <div id="trainFileInfo" class="stats" style="display: none; margin-top: 15px;"></div>
            </div>

            <!-- 训练数据清洗 -->
            <div class="section">
                <h2><i class="fas fa-broom"></i> 训练数据清洗</h2>
                <div class="form-group">
                    <label for="cleanFileId">选择要清洗的数据</label>
                    <select id="cleanFileId">
                        <option value="">请先上传数据</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="minLength">最小文本长度</label>
                    <input type="number" id="minLength" value="5" min="1" max="100">
                </div>
                <div class="form-group">
                    <label for="maxLength">最大文本长度</label>
                    <input type="number" id="maxLength" value="512" min="10" max="2000">
                </div>
                <button id="cleanDataBtn">清洗数据</button>
                <div id="cleanResult" class="stats" style="display: none; margin-top: 15px;"></div>
            </div>

            <!-- 训练配置 -->
            <div class="section">
                <h2><i class="fas fa-cogs"></i> 训练配置</h2>
                <div class="form-group">
                    <label for="baseModel">选择基础模型</label>
                    <select id="baseModel">
                        <option value="BAAI/bge-m3">BGE-M3 (推荐 - Mac优化)</option>
                        <option value="chinese-roberta-wwm-ext">Chinese RoBERTa WWM Ext</option>
                        <option value="bert-base-chinese">BERT Base Chinese</option>
                        <option value="sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2">Multilingual MiniLM</option>
                        <option value="shibing624/text2vec-base-chinese">Text2Vec Chinese</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="trainEpochs">训练轮数 (Epochs)</label>
                    <input type="number" id="trainEpochs" value="5" min="1" max="50">
                </div>
                <div class="form-group">
                    <label for="trainBatchSize">批次大小 (Batch Size)</label>
                    <input type="number" id="trainBatchSize" value="16" min="1" max="128">
                </div>
                <div class="form-group">
                    <label for="trainLearningRate">学习率 (Learning Rate)</label>
                    <input type="number" id="trainLearningRate" value="0.00002" step="0.00001" min="0.000001" max="0.001">
                </div>
            </div>

            <!-- 开始训练 -->
            <div class="section">
                <h2><i class="fas fa-play"></i> 开始训练</h2>
                <button id="startTrainBtn" class="secondary">开始训练模型</button>
                <button id="stopTrainBtn" class="danger" style="display: none;">停止训练</button>

                <div id="trainProgress" class="train-progress-container">
                    <div class="train-progress-bar">
                        <div id="trainProgressBar" class="train-progress-fill"></div>
                    </div>
                    <div id="trainProgressText" class="train-progress-text">0% 准备中...</div>
                </div>

                <div id="trainLogs" class="train-logs" style="display: none;"></div>
            </div>

            <!-- 模型管理 -->
            <div class="section">
                <h2><i class="fas fa-robot"></i> 已训练模型</h2>
                <button id="refreshModelsBtn" class="secondary">刷新模型列表</button>
                <div id="modelList" class="file-list">
                    <p style="padding: 20px; text-align: center; color: #666;">点击"刷新模型列表"查看已训练模型</p>
                </div>
            </div>

            <!-- 模型验证 -->
            <div class="section">
                <h2><i class="fas fa-check-circle"></i> 模型验证</h2>
                <button id="validateModelBtn" class="secondary">验证最新模型</button>
                <div id="validateResult" class="stats" style="display: none; margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <!-- 暗黑模式切换 -->
    <button id="darkModeBtn" class="dark-mode-toggle">切换暗黑模式</button>

    <script>
        // 全局变量
        let currentSearchResults = [];
        const API_KEY = "local_kb_2026_secure_key"; // 与配置文件一致
        const API_VERSION = "{{ api_version }}";

        // 1. 暗黑模式切换
        const darkModeBtn = document.getElementById('darkModeBtn');
        darkModeBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            // 保存到本地存储
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            // 重新渲染图表
            loadStatsChart();
        });

        // 初始化暗黑模式
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }

        // 2. 文件上传处理
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('file');
            const files = fileInput.files;
            if (files.length === 0) return;

            // 显示进度条
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            progressText.textContent = '0% 准备上传...';

            // 遍历上传每个文件
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    // 异步上传请求
                    const res = await fetch(`/api/${API_VERSION}/upload_async`, {
                        method: 'POST',
                        headers: {
                            'X-API-Key': API_KEY
                        },
                        body: formData
                    });

                    const data = await res.json();
                    if (data.success) {
                        // 轮询任务状态
                        const taskId = data.data.task_id;
                        progressText.textContent = `处理中（${file.name}）...`;

                        const pollInterval = setInterval(async () => {
                            const taskRes = await fetch(`/api/${API_VERSION}/task/${taskId}`, {
                                headers: { 'X-API-Key': API_KEY }
                            });
                            const taskData = await taskRes.json();

                            if (taskData.success) {
                                const task = taskData.data.task;
                                progressBar.style.width = `${task.progress}%`;

                                if (task.status === 'completed') {
                                    clearInterval(pollInterval);
                                    progressText.textContent = `完成：${task.message}`;
                                    // 3秒后隐藏进度条
                                    setTimeout(() => {
                                        progressDiv.style.display = 'none';
                                        fileInput.value = ''; // 清空文件选择
                                    }, 3000);
                                    // 刷新文件列表和图表
                                    refreshFileList();
                                    loadStatsChart();
                                } else if (task.status === 'failed') {
                                    clearInterval(pollInterval);
                                    progressText.textContent = `失败：${task.message}`;
                                }
                            }
                        }, 1000);
                    } else {
                        progressText.textContent = `上传失败：${data.message}`;
                    }
                } catch (err) {
                    progressText.textContent = `上传失败：${err.message}`;
                }
            }
        });

        // 3. 检索处理
        document.getElementById('searchForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('query', document.getElementById('query').value);
            formData.append('top_k', document.getElementById('top_k').value);
            formData.append('file_type_filter', document.getElementById('file_type_filter').value);
            formData.append('hybrid', document.getElementById('hybrid').value);

            // 显示加载状态
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 检索中，请稍候...</div>';

            try {
                const res = await fetch(`/api/${API_VERSION}/search`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY },
                    body: formData
                });

                const data = await res.json();
                resultsDiv.innerHTML = '';

                if (data.success && data.data.results.length > 0) {
                    currentSearchResults = data.data.results;
                    data.data.results.forEach((item, idx) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'result-item';
                        itemDiv.innerHTML = `
                            <h3>结果 ${idx+1}</h3>
                            <p class="distance">
                                相似度距离：${item.similarity_distance}
                                <span class="match-score">关键词匹配度：${item.match_score}</span>
                            </p>
                            <p>${item.highlighted_text || item.text}</p>
                            <p class="metadata">
                                来源：${item.metadata.file_path} |
                                类型：${item.metadata.file_type} |
                                版本：${item.metadata.version}
                            </p>
                        `;
                        resultsDiv.appendChild(itemDiv);
                    });
                } else {
                    resultsDiv.innerHTML = '<p style="text-align: center; padding: 20px;">未找到相关结果</p>';
                }
            } catch (err) {
                alert('检索失败：' + err.message);
            }
        });

        // 4. 导出检索结果
        document.getElementById('exportResultsBtn').addEventListener('click', () => {
            if (currentSearchResults.length === 0) {
                alert('暂无检索结果可导出');
                return;
            }

            const blob = new Blob([JSON.stringify(currentSearchResults, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `检索结果_${new Date().getTime()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // 5. 刷新文件列表
        async function refreshFileList() {
            try {
                const res = await fetch(`/api/${API_VERSION}/stats`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                const data = await res.json();

                const fileListDiv = document.getElementById('fileList');
                fileListDiv.innerHTML = '';

                if (data.success && data.data.file_list && data.data.file_list.length > 0) {
                    data.data.file_list.forEach(file => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                            <input type="checkbox" class="file-checkbox" value="${file.path}">
                            <div class="file-info">
                                <div class="file-name">${file.path}</div>
                                <div class="file-meta">
                                    类型：${file.type} | 文本块数：${file.chunk_count} |
                                    修改时间：${new Date(file.mtime * 1000).toLocaleString()}
                                </div>
                            </div>
                            <div class="file-actions">
                                <button onclick="deleteFile('${file.path}')">删除</button>
                            </div>
                        `;
                        fileListDiv.appendChild(fileItem);
                    });
                } else {
                    fileListDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">暂无入库文件</p>';
                }
            } catch (err) {
                alert('刷新文件列表失败：' + err.message);
            }
        }

        document.getElementById('refreshFilesBtn').addEventListener('click', refreshFileList);

        // 6. 删除单个文件
        async function deleteFile(filePath) {
            if (!confirm(`确认删除 ${filePath} 的所有入库数据？`)) return;

            try {
                const formData = new FormData();
                formData.append('file_path', filePath);

                const res = await fetch(`/api/${API_VERSION}/delete`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY },
                    body: formData
                });

                const data = await res.json();
                alert(data.message);
                refreshFileList();
                loadStatsChart();
            } catch (err) {
                alert('删除失败：' + err.message);
            }
        }

        // 7. 批量删除文件
        document.getElementById('batchDeleteBtn').addEventListener('click', async () => {
            const selectedFiles = document.querySelectorAll('.file-checkbox:checked');
            if (selectedFiles.length === 0) {
                alert('请选择要删除的文件');
                return;
            }

            if (!confirm(`确认删除选中的${selectedFiles.length}个文件？`)) return;

            const filePaths = Array.from(selectedFiles).map(checkbox => checkbox.value);

            try {
                const res = await fetch(`/api/${API_VERSION}/batch_delete`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ file_paths: filePaths })
                });

                const data = await res.json();
                alert(data.message);
                refreshFileList();
                loadStatsChart();
            } catch (err) {
                alert('批量删除失败：' + err.message);
            }
        });

        // 8. 清空知识库
        document.getElementById('clearBtn').addEventListener('click', async () => {
            if (!confirm('⚠️ 确认清空整个知识库？此操作不可恢复！')) return;

            try {
                const res = await fetch(`/api/${API_VERSION}/clear`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });

                const data = await res.json();
                alert(data.message);
                refreshFileList();
                loadStatsChart();
            } catch (err) {
                alert('清空失败：' + err.message);
            }
        });

        // 9. 加载统计图表
        async function loadStatsChart() {
            try {
                const res = await fetch(`/api/${API_VERSION}/stats`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                const data = await res.json();

                if (!data.success || !data.data.file_type_dist) return;

                // 初始化图表
                const chart = echarts.init(document.getElementById('fileTypeChart'));

                // 适配暗黑模式
                const isDark = document.body.classList.contains('dark-mode');
                const textColor = isDark ? '#f5f5f7' : '#1d1d1f';
                const bgColor = isDark ? '#2c2c2e' : 'transparent';

                // 图表配置
                const option = {
                    backgroundColor: bgColor,
                    title: {
                        text: '文件类型分布',
                        textStyle: { color: textColor }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: '{a} <br/>{b}: {c} ({d}%)'
                    },
                    legend: {
                        orient: 'vertical',
                        left: 'left',
                        textStyle: { color: textColor }
                    },
                    series: [
                        {
                            name: '文件类型',
                            type: 'pie',
                            radius: '50%',
                            data: Object.entries(data.data.file_type_dist).map(([name, value]) => ({
                                name: name,
                                value: value
                            })),
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            },
                            label: {
                                color: textColor
                            }
                        }
                    ]
                };

                chart.setOption(option);

                // 监听窗口大小变化
                window.addEventListener('resize', () => {
                    chart.resize();
                });
            } catch (err) {
                console.error('加载统计图表失败：' + err.message);
            }
        }

        // 页面加载完成后初始化图表
        window.addEventListener('load', () => {
            loadStatsChart();
        });

        // ========== 标签页导航 ==========
        const navTabs = document.querySelectorAll('.nav-tab');
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // 移除所有活动状态
                navTabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                // 激活当前标签页
                tab.classList.add('active');
                const tabId = tab.getAttribute('data-tab');
                document.getElementById('tab-' + tabId).classList.add('active');
            });
        });

        // ========== 模型训练功能 ==========

        // 训练数据上传
        let currentTrainFileId = null;
        document.getElementById('trainUploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fileInput = document.getElementById('trainFile');
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const res = await fetch(`/api/${API_VERSION}/train/upload`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY },
                    body: formData
                });
                const data = await res.json();

                if (data.success) {
                    currentTrainFileId = data.data.id;
                    const infoDiv = document.getElementById('trainFileInfo');
                    infoDiv.style.display = 'block';
                    infoDiv.innerHTML = `
                        <p><strong>文件名：</strong>${data.data.filename}</p>
                        <p><strong>总行数：</strong>${data.data.total_rows}</p>
                        <p><strong>列：</strong>${data.data.columns.join(', ')}</p>
                    `;
                    // 刷新数据列表
                    loadTrainDataList();
                } else {
                    alert('上传失败：' + data.message);
                }
            } catch (err) {
                alert('上传失败：' + err.message);
            }
        });

        // 加载训练数据列表
        async function loadTrainDataList() {
            try {
                const res = await fetch(`/api/${API_VERSION}/train/data`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                const data = await res.json();

                const select = document.getElementById('cleanFileId');
                select.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    data.data.forEach(f => {
                        const option = document.createElement('option');
                        option.value = f.id;
                        option.textContent = `${f.filename} (${(f.size / 1024).toFixed(1)}KB)`;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">暂无数据</option>';
                }
            } catch (err) {
                console.error('加载数据列表失败：' + err.message);
            }
        }

        // 数据清洗
        document.getElementById('cleanDataBtn').addEventListener('click', async () => {
            const fileId = document.getElementById('cleanFileId').value;
            if (!fileId) {
                alert('请选择要清洗的数据');
                return;
            }

            try {
                const res = await fetch(`/api/${API_VERSION}/train/clean`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        file_id: fileId,
                        min_length: parseInt(document.getElementById('minLength').value),
                        max_length: parseInt(document.getElementById('maxLength').value)
                    })
                });
                const data = await res.json();

                const resultDiv = document.getElementById('cleanResult');
                resultDiv.style.display = 'block';
                if (data.success) {
                    resultDiv.innerHTML = `
                        <p><strong>清洗完成！</strong></p>
                        <p>原始数量：${data.data.original_count}</p>
                        <p>清洗后数量：${data.data.cleaned_count}</p>
                        <p>保存文件名：${data.data.filename}</p>
                    `;
                    // 更新文件ID为清洗后的
                    const fileIdMatch = data.data.filename.match(/^clean_.*_([a-f0-9]+)_/);
                    if (fileIdMatch) {
                        currentTrainFileId = fileIdMatch[1];
                    }
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">清洗失败：${data.message}</p>`;
                }
            } catch (err) {
                alert('清洗失败：' + err.message);
            }
        });

        // 开始训练
        let trainPollInterval = null;
        document.getElementById('startTrainBtn').addEventListener('click', async () => {
            if (!currentTrainFileId) {
                alert('请先上传并清洗训练数据');
                return;
            }

            const config = {
                file_id: currentTrainFileId,
                base_model: document.getElementById('baseModel').value,
                epochs: parseInt(document.getElementById('trainEpochs').value),
                batch_size: parseInt(document.getElementById('trainBatchSize').value),
                learning_rate: parseFloat(document.getElementById('trainLearningRate').value)
            };

            try {
                const res = await fetch(`/api/${API_VERSION}/train/start`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('startTrainBtn').style.display = 'none';
                    document.getElementById('stopTrainBtn').style.display = 'inline-block';
                    document.getElementById('trainProgress').style.display = 'block';
                    document.getElementById('trainLogs').style.display = 'block';

                    // 开始轮询训练状态
                    trainPollInterval = setInterval(async () => {
                        const statusRes = await fetch(`/api/${API_VERSION}/train/status`, {
                            headers: { 'X-API-Key': API_KEY }
                        });
                        const statusData = await statusRes.json();

                        if (statusData.success) {
                            const status = statusData.data;
                            document.getElementById('trainProgressBar').style.width = status.progress + '%';
                            document.getElementById('trainProgressText').textContent = status.progress + '% 训练中...';

                            if (status.logs && status.logs.length > 0) {
                                document.getElementById('trainLogs').textContent = status.logs.join('\n');
                            }

                            if (!status.running && status.progress >= 100) {
                                clearInterval(trainPollInterval);
                                document.getElementById('startTrainBtn').style.display = 'inline-block';
                                document.getElementById('stopTrainBtn').style.display = 'none';
                                document.getElementById('trainProgressText').textContent = '训练完成！';
                                refreshModelList();
                            }
                        }
                    }, 2000);
                } else {
                    alert('启动失败：' + data.message);
                }
            } catch (err) {
                alert('启动失败：' + err.message);
            }
        });

        // 停止训练
        document.getElementById('stopTrainBtn').addEventListener('click', async () => {
            try {
                await fetch(`/api/${API_VERSION}/train/stop`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });
                clearInterval(trainPollInterval);
                document.getElementById('startTrainBtn').style.display = 'inline-block';
                document.getElementById('stopTrainBtn').style.display = 'none';
            } catch (err) {
                alert('停止失败：' + err.message);
            }
        });

        // 刷新模型列表
        async function refreshModelList() {
            try {
                const res = await fetch(`/api/${API_VERSION}/train/models/list`, {
                    headers: { 'X-API-Key': API_KEY }
                });
                const data = await res.json();

                const listDiv = document.getElementById('modelList');
                listDiv.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    data.data.forEach(m => {
                        const item = document.createElement('div');
                        item.className = 'file-item';
                        item.innerHTML = `
                            <div class="file-info">
                                <div class="file-name">${m.version}</div>
                                <div class="file-meta">
                                    路径：${m.path} | 有效：${m.valid ? '是' : '否'} | 部署：${m.deployed ? '是' : '否'}
                                </div>
                            </div>
                            <div class="file-actions">
                                <button onclick="deployModel('${m.version}')">部署</button>
                            </div>
                        `;
                        listDiv.appendChild(item);
                    });
                } else {
                    listDiv.innerHTML = '<p style="padding: 20px; text-align: center; color: #666;">暂无已训练模型</p>';
                }
            } catch (err) {
                console.error('加载模型列表失败：' + err.message);
            }
        }

        document.getElementById('refreshModelsBtn').addEventListener('click', refreshModelList);

        // 部署模型
        window.deployModel = async function(version) {
            if (!confirm(`确认部署模型 ${version}？`)) return;

            try {
                const res = await fetch(`/api/${API_VERSION}/train/deploy`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': API_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ version: version })
                });
                const data = await res.json();
                alert(data.message);
                refreshModelList();
            } catch (err) {
                alert('部署失败：' + err.message);
            }
        };

        // 验证模型
        document.getElementById('validateModelBtn').addEventListener('click', async () => {
            try {
                const res = await fetch(`/api/${API_VERSION}/train/validate`, {
                    method: 'POST',
                    headers: { 'X-API-Key': API_KEY }
                });
                const data = await res.json();

                const resultDiv = document.getElementById('validateResult');
                resultDiv.style.display = 'block';

                if (data.success) {
                    let html = `<p><strong>模型验证结果</strong></p>`;
                    data.data.results.forEach(r => {
                        html += `<p>${r.test}: ${r.status} - ${JSON.stringify(r.detail)}</p>`;
                    });
                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">验证失败：${data.message}</p>`;
                }
            } catch (err) {
                alert('验证失败：' + err.message);
            }
        });
    </script>
</body>
</html>
