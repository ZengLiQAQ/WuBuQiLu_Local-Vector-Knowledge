# 本地向量知识库最佳实践规格说明

## 项目背景

基于对现有项目 `WuBuQiLu_Local-Vector-Knowledge` 和 GitHub 上最佳实践的研究，制定本规格说明。

## 行业参考

1. **FAISS** (Facebook) - 高效相似性搜索，支持数十亿向量
2. **GraphRAG** (Microsoft) - 知识图谱增强RAG
3. **FlagEmbedding** (BAAI) - BGE系列模型，一站式检索工具

## 核心功能架构

```
┌─────────────────────────────────────────────────────────┐
│                    Web UI (FastAPI)                     │
│  - 知识库管理 Tab                                       │
│  - 模型训练 Tab                                         │
└──────────────────┬──────────────────────────────────────┘
                   │
        ┌──────────┴──────────┐
        ▼                     ▼
┌───────────────────┐  ┌───────────────────┐
│  LocalVectorKB   │  │  ModelTrain      │
│  (知识库管理)     │  │  (模型训练)       │
│  - 文件导入       │  │  - 数据制备      │
│  - 向量化存储     │  │  - 模型微调      │
│  - 语义检索       │  │  - 模型验证      │
│  - 知识图谱      │  │  - 模型部署      │
└───────────────────┘  └───────────────────┘
        │                     │
        └──────────┬──────────┘
                   ▼
┌─────────────────────────────────────────────────────────┐
│              Embedding Models (BGE-M3)                  │
│  - BGE-M3 (默认,推荐)                                  │
│  - BGE-Reranker                                        │
│  - 自定义微调模型                                       │
└─────────────────────────────────────────────────────────┘
```

## 功能规格

### 1. 知识库管理 (现有功能)

| 功能 | 状态 | 说明 |
|------|------|------|
| PDF导入 | ✅ | 流式解析，减少内存 |
| Markdown导入 | ✅ | 转为纯文本 |
| Excel导入 | ✅ | 按工作表合并 |
| 异步处理 | ✅ | 后台任务队列 |
| 语义检索 | ✅ | 向量相似度匹配 |
| 知识图谱 | ⏳ | 待增强 |

### 2. 模型训练 (新增功能)

| 功能 | 状态 | 说明 |
|------|------|------|
| 数据上传 | ✅ | CSV格式 |
| 数据清洗 | ✅ | 长度过滤、去重 |
| 数据增强 | ✅ | 噪声样本生成 |
| 训练对生成 | ✅ | 自对比/全量配对 |
| 钉钉文档导入 | ✅ | Q:A格式解析 |
| BGE-M3微调 | ✅ | Mac MPS加速 |
| 模型验证 | ✅ | 编码测试、相似度验证 |
| 模型部署 | ✅ | 一键部署 |

### 3. 数据制备流程

```
钉钉文档 / CSV上传
       │
       ▼
┌──────────────────┐
│  数据验证        │ ← 检查空值、长度、score范围
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  数据清洗        │ ← 去特殊字符、长度过滤
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  数据增强        │ ←  /样本复制+噪声 同义词
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  训练对生成      │ ← 自对比/采样配对
└────────┬─────────┘
         │
         ▼
    模型训练
```

### 4. 检索增强

| 功能 | 说明 |
|------|------|
| 稠密向量 | BGE-M3 默认可选 |
| 稀疏向量 | BM25备选 |
| 重排序 | BGE-Reranker |
| 混合检索 | 稠密+稀疏融合 |

## 技术规格

### 模型配置

```yaml
embedding:
  default_model: "BAAI/bge-m3"
  dimension: 1024
  max_length: 8192
  device: "mps"  # Mac优化

retrieval:
  top_k: 5
  similarity_threshold: 0.7
  hybrid_search: true
  rerank: true
```

### 训练配置

```yaml
training:
  default_model: "BAAI/bge-m3"
  epochs: 3-5
  batch_size: 4-16
  learning_rate: 2e-5
  device: "mps"  # Mac MPS加速
```

## API规格

### 知识库API
- `POST /api/v1/upload` - 上传文件
- `GET /api/v1/search` - 语义检索
- `GET /api/v1/stats` - 统计信息

### 训练API
- `POST /api/v1/train/upload` - 上传训练数据
- `POST /api/v1/train/start` - 启动训练
- `GET /api/v1/train/status` - 训练状态
- `POST /api/v1/train/deploy` - 部署模型

## 已知问题

1. ~~训练数据制备功能缺失~~ → 已解决
2. ~~不支持钉钉文档导入~~ → 已解决
3. ~~缺少模型微调功能~~ → 已解决
4. 知识图谱可视化待增强

## 执行计划

- [x] Phase 1: 基础框架搭建
- [x] Phase 2: 知识库管理功能
- [x] Phase 3: 模型训练功能
- [ ] Phase 4: 知识图谱增强
- [ ] Phase 5: 混合检索优化
